<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Character | 190 Expanded Wiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/tw3k.css" />

  <style>
    /* [Previous styles remain the same until the Family Tree helpers section] */
    /* =========================
   Element Theme (Muted / TW-style)
   ========================= */

    .character-page {
      --theme: #9a8648; /* fallback: aged earth gold */
      --theme-soft: rgba(154, 134, 72, 0.16);
      --theme-glow: rgba(154, 134, 72, 0.22);
    }

    /* Muted element mappings */
    .character-page[data-element="water"] {
      --theme: #4f6f8f;
      --theme-soft: rgba(79, 111, 143, 0.16);
      --theme-glow: rgba(79, 111, 143, 0.22);
    }

    .character-page[data-element="wood"] {
      --theme: #4f7a55;
      --theme-soft: rgba(79, 122, 85, 0.16);
      --theme-glow: rgba(79, 122, 85, 0.22);
    }

    .character-page[data-element="fire"] {
      --theme: #8c3a3a;
      --theme-soft: rgba(140, 58, 58, 0.16);
      --theme-glow: rgba(140, 58, 58, 0.22);
    }

    .character-page[data-element="earth"] {
      --theme: #9a8648;
      --theme-soft: rgba(154, 134, 72, 0.16);
      --theme-glow: rgba(154, 134, 72, 0.22);
    }

    .character-page[data-element="metal"] {
      --theme: #7a6a99;
      --theme-soft: rgba(122, 106, 153, 0.16);
      --theme-glow: rgba(122, 106, 153, 0.22);
    }

    .character-page[data-element="nanman"] {
      --theme: #7f8f4a;
      --theme-soft: rgba(127, 143, 74, 0.16);
      --theme-glow: rgba(127, 143, 74, 0.22);
    }

     .trait-tooltip .t-effects {
       margin-top: 8px;
       padding-top: 8px;
       border-top: 1px solid rgba(255,255,255,0.10);
       display: flex;
       flex-direction: column;
       gap: 4px;
     }

     .trait-tooltip .t-effects-header {
       font-family: 'Cinzel', serif;
       font-size: 0.65rem;
       letter-spacing: 0.08em;
       text-transform: uppercase;
       color: rgba(255,255,255,0.70);
     }

     .trait-tooltip .t-effect {
       font-size: 0.8rem;
       color: rgba(255,255,255,0.80);
       line-height: 1.25;
       background: rgba(255,255,255,0.04);
       border-left: 2px solid rgba(255,255,255,0.18);
       padding: 2px 6px;
     }


    /* =========================
       Character Page Layout
       ========================= */

    .character-page {
      display: grid;
      grid-template-columns: 1.6fr 0.9fr;
      min-height: 800px;
      border: 1px solid #252530;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 0 18px var(--theme-glow);
    }

    /* Left content area */
    .content-area {
      display: flex;
      flex-direction: column;
    }

    /* Row 1: Title/Desc + Name/Dates */
    .row-top {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      border-bottom: 1px solid #252530;
    }

    /* Row 2: Bio + Effects */
    .row-bottom {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      flex: 1;
    }

    /* =========================
       Portrait column (right)
       ========================= */

    .portrait-column {
      background-color: #0a0a0c;
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      border-left: 1px solid #252530;
      position: relative;
      min-height: 500px;
      overflow: visible;
    }

    /* Contain mode - shows full image */
    .portrait-column.contain-mode {
      background-size: contain;
      background-position: center center;
    }

    .portrait-column::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(to top, rgba(10,10,12,0.9) 0%, transparent 100%);
      pointer-events: none;
    }

    .portrait-toggle {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--text-muted);
      padding: 0.3rem 0.5rem;
      font-size: 0.65rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }

    .portrait-toggle:hover {
      background: rgba(40,40,40,0.9);
      color: var(--text-secondary);
      border-color: rgba(255,255,255,0.28);
    }

    .no-portrait-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* =========================
       TRAITS (icons next to portrait)
       ========================= */

    .trait-strip {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 50;

      display: flex;
      flex-direction: column;  /* <-- vertical */
      flex-wrap: nowrap;        /* <-- no wrapping */
      gap: 8px;

      max-width: none;
      pointer-events: auto;
    }

    /* Make trait list vertical */
    #trait-strip.trait-strip {
      position: absolute;
      top: 12px;
      left: 12px;

      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 8px;

      z-index: 9998;          /* higher than basically everything */
      pointer-events: auto;
    }

    /* Ensure each icon can be hovered */
    #trait-strip .trait-icon {
      width: 42px;
      height: 42px;

      position: relative;
      z-index: 9999;          /* keep tooltip above portrait overlays */
      cursor: default;

      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);

      display: grid;
      place-items: center;
      overflow: visible;      /* critical: tooltip is a child */
    }

    /* Tooltip default: fully hidden */
    #trait-strip .trait-tooltip {
      position: absolute;
      left: calc(100% + 10px);  /* show to the right (best for vertical list) */
      top: 0;

      min-width: 260px;
      max-width: 360px;

      background: rgba(10,10,14,0.96);
      border: 1px solid #2a2a35;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.55);

      display: none;           /* <-- avoids opacity/z-index conflicts */
      visibility: hidden;
      opacity: 0;

      transform: translateX(-4px);
      transition: opacity 120ms ease, transform 120ms ease;

      z-index: 10000;
      pointer-events: none;    /* keeps hover stable */
    }

    /* Tooltip on hover: force show (wins over tw3k.css) */
    #trait-strip .trait-icon:hover > .trait-tooltip {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      transform: translateX(0) !important;
    }


    .trait-icon {
      width: 42px;
      height: 42px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);
      display: grid;
      place-items: center;
      overflow: hidden;
      position: relative;
      cursor: default;
    }

    .trait-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .trait-badge {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      font-family: 'Cinzel', serif;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: rgba(255,255,255,0.85);
      text-transform: uppercase;
      font-size: 0.8rem;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    .trait-tooltip {
      position: absolute;
      left: 0;
      top: calc(100% + 10px);
      min-width: 260px;
      max-width: 360px;
      background: rgba(10,10,14,0.96);
      border: 1px solid #2a2a35;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.55);
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
      z-index: 20;
    }

    .trait-icon:hover .trait-tooltip {
      opacity: 1;
      transform: translateY(0);
    }

    .trait-tooltip .t-title {
      font-family: 'Cinzel', serif;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.92);
      margin: 0 0 6px 0;
      line-height: 1.2;
    }

    .trait-tooltip .t-desc {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.75);
      margin: 0;
      line-height: 1.35;
      white-space: normal;
    }

    /* =========================
       Shared panel styling
       ========================= */

    .panel {
      background: var(--bg-card);
      padding: 1.5rem;
    }

    .panel-divider-right {
      border-right: 1px solid #252530;
    }

    .panel-divider-bottom {
      border-bottom: 1px solid #252530;
    }

    /* =========================
       Title/Description Panel
       ========================= */

    .title-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 180px;
      border-left: 4px solid var(--theme);
    }

    .char-title {
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color, var(--gold-primary));
      margin: 0 0 0.75rem 0;
      text-shadow: 0 0 6px var(--theme-glow, rgba(0,0,0,0.4));
    }

    /* Muted element mappings — char-title ONLY */
    .char-title[data-element="water"] { --color: #4f6f8f; --theme-glow: rgba(79, 111, 143, 0.22); }
    .char-title[data-element="wood"] { --color: #4f7a55; --theme-glow: rgba(79, 122, 85, 0.22); }
    .char-title[data-element="fire"] { --color: #8c3a3a; --theme-glow: rgba(140, 58, 58, 0.22); }
    .char-title[data-element="earth"] { --color: #9a8648; --theme-glow: rgba(154, 134, 72, 0.22); }
    .char-title[data-element="metal"] { --color: #7a6a99; --theme-glow: rgba(122, 106, 153, 0.22); }
    .char-title[data-element="nanman"] { --color: #7f8f4a; --theme-glow: rgba(127, 143, 74, 0.22); }

    .char-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 0;
      font-style: italic;
    }

    .no-title-desc {
      color: var(--text-muted);
      font-style: italic;
    }

    /* =========================
       Name/Info Panel
       ========================= */

    .info-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 180px;
    }

    .info-panel h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--title-cream);
      margin: 0 0 0.2rem 0;
    }

    .chinese-name {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-left: 0.5rem;
      font-weight: normal;
      opacity: 0.8;
    }

    .courtesy-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0.75rem 0;
    }

    .courtesy-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-right: 0.5rem;
    }

    .chinese-text {
      margin-left: 0.5rem;
      opacity: 0.8;
    }

    .char-dates {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 1rem 0;
    }

    .char-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid #353530;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tag.unique { border-color: var(--gold-dark); color: var(--gold-light); }
    .tag.generic { border-color: #353530; }
    .tag.male { border-color: #6b8cae; color: #8ab4d9; }
    .tag.female { border-color: #9966cc; color: #cc99ff; }

    .tag.element {
      background: rgba(0,0,0,0.25);
      border-color: var(--theme);
      color: var(--theme);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }

    /* =========================
       Bio Panel
       ========================= */

    .bio-panel {
      min-height: 250px;
    }

    .panel-header {
      font-family: 'Cinzel', serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .bio-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.7;
      margin: 0;
    }

    .no-content {
      color: var(--text-muted);
      font-style: italic;
    }

    /* =========================
       Effects Panel
       ========================= */

    .effects-panel {
      min-height: 250px;
    }

    .effect-category {
      margin-bottom: 1rem;
    }

    .effect-category:last-child { margin-bottom: 0; }

    .effect-category-header {
      font-size: 0.7rem;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 0.5rem 0;
      padding-bottom: 0.25rem;
      border-bottom: 1px dashed rgba(255,255,255,0.10);
      font-family: 'Cinzel', serif;
    }

    .effect-category-items {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .effect-item {
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.02);
      border-left: 2px solid rgba(255,255,255,0.10);
    }

    /* =========================
       Technical Details
       ========================= */

    .tech-details {
      margin-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top: 1rem;
    }

    .tech-details summary {
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      outline: none;
    }

    .tech-details summary:hover { color: var(--text-secondary); }

    .tech-details dl {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 1rem;
      margin: 1rem 0 0 0;
      font-size: 0.8rem;
    }

    .tech-details dt {
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 0.65rem;
      letter-spacing: 0.05em;
    }

    .tech-details dd {
      margin: 0;
      color: var(--text-secondary);
    }

    .tech-details code {
      font-family: monospace;
      font-size: 0.75rem;
      background: rgba(255,255,255,0.04);
      padding: 0.1rem 0.3rem;
      border-radius: 2px;
    }

    /* =========================
       Tabs Section
       ========================= */

    .tabs-section {
      margin-top: 2rem;
      background: var(--bg-card);
      border: 1px solid #252530;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 0 18px var(--theme-glow);
    }

    .tabs-header {
      display: flex;
      border-bottom: 1px solid #252530;
      background: rgba(0,0,0,0.2);
    }

    .tab-btn {
      padding: 1rem 1.5rem;
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.02);
    }

    .tab-btn.active {
      color: var(--theme);
      border-bottom-color: var(--theme);
      background: rgba(255,255,255,0.03);
    }

    .tab-content {
      display: none;
      padding: 1.5rem;
    }

    .tab-content.active {
      display: block;
    }

    /* =========================
       Family Tree Section (inside tab)
       ========================= */

    .family-tree-header {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .family-group {
      margin-bottom: 2rem;
    }

    .family-group:last-child { margin-bottom: 0; }

    .family-group-title {
      font-family: 'Cinzel', serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      opacity: 0.85;
    }

    .family-members {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .family-member {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      position: relative;
      transition: all 0.2s ease;
    }

    .family-member:hover { transform: translateY(-2px); }

    .family-member-missing {
      opacity: 0.5;
      cursor: default;
    }

    .family-member-missing:hover { transform: none; }

    .family-portrait {
      width: 80px;
      height: 80px;
      border-radius: 4px;
      border: 2px solid #353535;
      background-color: #0a0a0c;
      background-size: cover;
      background-position: center top;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: all 0.2s ease;
    }

    .family-member:hover .family-portrait {
        border-color: var(--theme);
        box-shadow: 0 0 12px var(--theme-glow);
    }

    .family-portrait.no-portrait {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a1a1d 0%, #0a0a0c 100%);
    }

    .family-portrait.no-portrait::after {
        content: '?';
        font-family: 'Cinzel', serif;
        font-size: 1.8rem;
        color: var(--text-muted);
    }

    .family-member-name {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: center;
        max-width: 100px;
        line-height: 1.2;
    }

    .family-member:hover .family-member-name { color: var(--title-cream); }

    .relationship-label {
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.6rem;
        padding: 0.1rem 0.4rem;
        background: var(--bg-card);
        border: 1px solid #252530;
        color: var(--theme);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        z-index: 1;
    }

    .family-tree-empty {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .family-connections {
        position: relative;
        padding: 2rem 0;
    }

    /* Extended family section */
    .extended-family-section {
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }

    .extended-family-header {
        font-family: 'Cinzel', serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--theme);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        opacity: 0.8;
    }

    /* =========================
       Skill Tree Section
       ========================= */

    .skill-tree-container {
      position: relative;
    }

    .skill-tree-header {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .skill-tree-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Grid-based skill tree layout */
    .skill-tree-grid {
      position: relative;
      background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 20px;
      min-height: 300px;
      overflow-x: auto;
      display: flex;
      justify-content: center;
    }

    .skill-tree-canvas {
      position: relative;
      min-width: 600px;
    }

    /* Game Mode Toggle */
    .skill-tree-mode-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .skill-tree-mode-btn {
      padding: 0.5rem 1rem;
      font-family: 'Cinzel', serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      background: rgba(0,0,0,0.3);
      border: 1px solid #353535;
      border-radius: 4px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s ease;
    }

    .skill-tree-mode-btn:hover {
      color: var(--text-secondary);
      border-color: #4a4a4a;
      background: rgba(255,255,255,0.05);
    }

    .skill-tree-mode-btn.active {
      color: var(--theme);
      border-color: var(--theme);
      background: var(--theme-soft);
    }

    /* Hide nodes based on game mode filter */
    .skill-tree-canvas[data-mode="romance"] .skill-node[data-game-mode="historical"] {
      display: none;
    }

    .skill-tree-canvas[data-mode="historical"] .skill-node[data-game-mode="romance"] {
      display: none;
    }

    /* SVG layer for connection lines */
    .skill-tree-links {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .skill-tree-links line {
      stroke: #4a4a4a;
      stroke-width: 2;
      stroke-dasharray: 4 4;
    }

    .skill-tree-links line.unlocked {
      stroke: var(--theme);
      stroke-dasharray: none;
    }

    /* Nodes layer */
    .skill-tree-nodes {
      position: relative;
      z-index: 2;
    }

    .skill-node {
      position: absolute;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid #353535;
      background: radial-gradient(circle at 30% 30%, #1a1a1d, #0a0a0c);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
      /* Center the node on its position */
      transform: translate(-50%, -50%);
    }

    .skill-node:hover {
      border-color: var(--theme);
      box-shadow: 0 0 20px var(--theme-glow), 0 4px 12px rgba(0,0,0,0.5);
      transform: translate(-50%, -50%) scale(1.08);
      z-index: 100;
    }

    .skill-node.unlocked {
      border-color: var(--theme);
      box-shadow: 0 0 12px var(--theme-glow), 0 4px 12px rgba(0,0,0,0.5);
    }

    .skill-node.locked {
      opacity: 0.7;
      filter: grayscale(40%);
    }

    /* Lock icon in bottom-right corner */
    .skill-node.locked::after {
      content: '';
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 22px;
      height: 22px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23aa9955"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>') no-repeat center;
      background-color: rgba(10, 10, 12, 0.9);
      background-size: 14px 14px;
      border-radius: 50%;
      border: 1px solid #4a4a4a;
      z-index: 5;
    }

    .skill-node-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }

    .skill-node-icon.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel', serif;
      font-size: 1.2rem;
      color: var(--text-muted);
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }

    /* Skill Tooltip */
    .skill-tooltip {
      position: absolute;
      left: calc(100% + 15px);
      top: 50%;
      transform: translateY(-50%);
      min-width: 280px;
      max-width: 380px;
      background: rgba(10,10,14,0.98);
      border: 1px solid #3a3a45;
      border-radius: 8px;
      padding: 14px 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
      z-index: 1000;
    }

    .skill-node:hover .skill-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Tooltip positioning for right-side nodes */
    .skill-node.tooltip-left .skill-tooltip {
      left: auto;
      right: calc(100% + 15px);
    }

    /* Tooltip positioning for top-row nodes - show below instead */
    .skill-node.tooltip-below .skill-tooltip {
      left: 50%;
      top: calc(100% + 15px);
      transform: translateX(-50%);
    }

    /* Combined: top-row + right-side */
    .skill-node.tooltip-below.tooltip-left .skill-tooltip {
      left: auto;
      right: 0;
      transform: none;
    }

    .skill-tooltip-title {
      font-family: 'Cinzel', serif;
      font-size: 1.05rem;
      color: var(--theme);
      margin: 0 0 8px 0;
      line-height: 1.2;
    }

    .skill-tooltip-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0 0 12px 0;
      line-height: 1.5;
    }

    .skill-tooltip-effects {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }

    .skill-tooltip-effects-header {
      font-family: 'Cinzel', serif;
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.55);
      margin-bottom: 8px;
    }

    .skill-tooltip-effect {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.85);
      line-height: 1.35;
      background: rgba(255,255,255,0.04);
      border-left: 2px solid var(--theme);
      padding: 4px 10px;
      margin-bottom: 5px;
    }

    .skill-tooltip-effect:last-child {
      margin-bottom: 0;
    }

    .skill-tooltip-meta {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .skill-tooltip-meta span {
      display: inline-block;
      margin-right: 14px;
    }

    /* Row labels */
    .skill-tree-row-labels {
      position: absolute;
      left: 0;
      top: 0;
      width: 30px;
      height: 100%;
      z-index: 3;
    }

    .skill-tree-row-label {
      position: absolute;
      left: 0;
      transform: translateY(-50%);
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--theme);
      opacity: 0.7;
    }

    /* =========================
       Responsive
       ========================= */

    @media (max-width: 1000px) {
      .character-page { grid-template-columns: 1fr; }

      .portrait-column {
        min-height: 300px;
        order: -1;
      }

      .row-top, .row-bottom { grid-template-columns: 1fr; }

      .panel-divider-right {
        border-right: none;
        border-bottom: 1px solid #252530;
      }

      .family-members { gap: 1rem; }
      .family-portrait { width: 60px; height: 60px; }

      .skill-tooltip {
        left: 50%;
        top: calc(100% + 10px);
        transform: translateX(-50%);
      }
    }
  </style>
</head>

<body>
  <div class="page-bg"></div>

  <header>
    <nav class="top-nav">
      <a href="../index.html" class="back-link">← Back to Hub</a>
    </nav>
    <div class="header-content">
      <p class="subtitle">190 Expanded Wiki</p>
      <h1>Character</h1>
    </div>
  </header>

  <nav class="main-nav">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="factions.html">Factions</a></li>
      <li><a href="characters.html" class="active">Characters</a></li>
      <li><a href="guides.html">Guides</a></li>
      <li><a href="changelog.html">Changelog</a></li>
    </ul>
  </nav>

  <main>
    <a class="back-link" href="characters.html" style="margin-bottom: 1rem; display: inline-block;">← Back to Characters</a>
    <section id="character-root" class="character-page"></section>
    
    <!-- Tabbed Section for Family Tree and Skills -->
    <section id="tabs-section" class="tabs-section" style="display: none;">
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="family-tree">Family Tree</button>
        <button class="tab-btn" data-tab="skills">Skills</button>
      </div>
      <div id="tab-family-tree" class="tab-content active"></div>
      <div id="tab-skills" class="tab-content"></div>
    </section>
  </main>

  <footer>
    <p>190 Expanded Wiki · Created by Ironic</p>
  </footer>

  <script src="data/characters.js"></script>
  <script src="data/character_details.js"></script>
  <script src="data/character_bios.js"></script>
  <script src="data/family_tree.js"></script>
  <script src="data/traits.js"></script>
  <script src="data/skill_trees.js"></script>

  <script>
    function escapeHtml(s) {
      return String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /* =========================
       Tabs functionality
       ========================= */

    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.getAttribute('data-tab');

          // Remove active class from all
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));

          // Add active class to clicked
          btn.classList.add('active');
          document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
      });
    }

    /* =========================
       Traits helpers
       ========================= */

    // Your site-relative path to trait icon folder:
    // (Windows path: total_war\data\UI\Campaign UI\traits)
    // becomes (web path): data/UI/Campaign UI/traits
    // NOTE: spaces must be URL-encoded when used in href/src.
    const TRAIT_ICON_BASE = 'data/UI/Campaign%20UI/traits/';

    function getTraitObject(traitKey) {
      if (!traitKey) return null;
      if (typeof TRAIT_LOOKUP !== 'undefined' && TRAIT_LOOKUP && TRAIT_LOOKUP[traitKey]) return TRAIT_LOOKUP[traitKey];
      if (typeof TRAIT_DATA !== 'undefined' && Array.isArray(TRAIT_DATA)) {
        return TRAIT_DATA.find(t => t && t.key === traitKey) || null;
      }
      return null;
    }

    function normalizeIconCandidates(iconPath) {
      const out = [];
      const pRaw = String(iconPath || '')
        .replace(/^[\\/]+/, '')
        .replace(/\\/g, '/')
        .replace(/^\/+/, '');

      if (!pRaw) return out;

      // If icon_path already contains the full traits folder path, use as-is (after encoding spaces).
      // If it's just a filename, we join it with TRAIT_ICON_BASE.
      const p = encodeURI(pRaw); // encodes spaces etc but keeps slashes

      // 1) Direct path (relative to site root)
      out.push(p.endsWith('.png') || p.endsWith('.webp') ? p : (p + '.png'));
      out.push(p.endsWith('.png') || p.endsWith('.webp') ? p : (p + '.webp'));

      // 2) Base folder + leaf filename
      const leaf = encodeURIComponent(pRaw.split('/').pop() || '');
      if (leaf) {
        out.push(TRAIT_ICON_BASE + leaf);        // if leaf already includes extension
        out.push(TRAIT_ICON_BASE + leaf + '.png');
        out.push(TRAIT_ICON_BASE + leaf + '.webp');
      }

      // 3) If it starts with ui/, try mapping to your data/UI/... tree
      // Example: ui/campaign ui/traits/foo -> data/UI/Campaign UI/traits/foo
      const lower = pRaw.toLowerCase();
      if (lower.startsWith('ui/')) {
        const afterUi = pRaw.slice(3); // remove "ui/"
        // attempt: data/UI/<afterUi>
        const mapped = 'data/UI/' + encodeURI(afterUi);
        out.push(mapped.endsWith('.png') || mapped.endsWith('.webp') ? mapped : (mapped + '.png'));
        out.push(mapped.endsWith('.png') || mapped.endsWith('.webp') ? mapped : (mapped + '.webp'));
      }

      return out;
    }

    function fallbackIconCandidatesByKey(traitKey) {
      const k = String(traitKey || '').toLowerCase();
      const leaf = encodeURIComponent(k);
      return [
        TRAIT_ICON_BASE + leaf + '.png',
        TRAIT_ICON_BASE + leaf + '.webp',
        `images/traits/${k}.png`,
        `images/traits/${k}.webp`
      ];
    }

    function setImgWithFallback(imgEl, candidates, onFailAll) {
      let i = 0;
      function tryNext() {
        if (i >= candidates.length) {
          if (typeof onFailAll === 'function') onFailAll();
          return;
        }
        imgEl.src = candidates[i++];
      }
      imgEl.onerror = tryNext;
      tryNext();
    }

    function buildTraitIcon(traitKey) {
      const trait = getTraitObject(traitKey) || { key: traitKey };

      const title = String(trait.title || traitKey || '').trim();
      const desc = String(trait.desc || trait.description || '').trim();

      const wrap = document.createElement('div');
      wrap.className = 'trait-icon';
      wrap.setAttribute('data-trait', traitKey);

      const tooltip = document.createElement('div');
      tooltip.className = 'trait-tooltip';
      tooltip.innerHTML = (() => {
        const eff = Array.isArray(trait.effects) ? trait.effects : [];
        const effHtml = eff.length
          ? `<div class="t-effects">
              <div class="t-effects-header">Effects</div>
              ${eff.map(e => `<div class="t-effect">${escapeHtml(e.name || e.formatted || e)}</div>`).join('')}
            </div>`
          : '';
        return `<div class="t-title">${escapeHtml(title)}</div>
                ${desc ? `<p class="t-desc">${escapeHtml(desc)}</p>` : ''}
                ${effHtml}`;
      })();

      const iconPath = trait.icon || trait.icon_path || '';
      if (iconPath) {
        const candidates = [
          ...normalizeIconCandidates(iconPath),
          ...fallbackIconCandidatesByKey(traitKey)
        ];
        const img = document.createElement('img');
        img.alt = title;
        setImgWithFallback(img, candidates, () => {
          img.remove();
          const badge = document.createElement('div');
          badge.className = 'trait-badge';
          badge.textContent = (title || '?')[0].toUpperCase();
          wrap.insertBefore(badge, tooltip);
        });
        wrap.appendChild(img);
      } else {
        const badge = document.createElement('div');
        badge.className = 'trait-badge';
        badge.textContent = (title || '?')[0].toUpperCase();
        wrap.appendChild(badge);
      }

      wrap.appendChild(tooltip);
      return wrap;
    }

    function renderTraitsIntoPortrait(traits) {
      const strip = document.getElementById('trait-strip');
      if (!strip || !Array.isArray(traits) || traits.length === 0) return;

      strip.innerHTML = '';
      traits.forEach(traitKey => {
        const icon = buildTraitIcon(traitKey);
        strip.appendChild(icon);
      });
    }

    /* =========================
       Family Tree helpers - UPDATED
       ========================= */

    // Helper function to get character key from various formats
    function getCharacterKey(idOrTemplate) {
      if (!idOrTemplate) return null;
      
      // If it contains ':', it's a full ID
      if (idOrTemplate.includes(':')) {
        const parts = idOrTemplate.split(':');
        if (parts.length >= 6) {
          const template = parts[0].trim();
          const templateId = parts[5].trim();
          return template + '#' + templateId;
        }
        return parts[0].trim();
      }
      
      // Otherwise, it's already a key/template
      return idOrTemplate;
    }

    // Extract template from character key (for finding character data)
    function getTemplateFromKey(characterKey) {
      if (!characterKey) return null;
      
      // If it has a template_id, extract just the template
      if (characterKey.includes('#')) {
        return characterKey.split('#')[0];
      }
      
      return characterKey;
    }

    function extractNameForMissingCharacter(characterKey, currentFamilyName, relationship) {
        if (!characterKey) return 'Unknown';
        
        // Remove template_id if present
        const templateKey = characterKey.includes('#') 
            ? characterKey.split('#')[0] 
            : characterKey;
        
        const isGeneric = templateKey.toLowerCase().includes('generic') || 
                         templateKey.toLowerCase().includes('villager') || 
                         templateKey.toLowerCase().includes('normal');
        
        if (isGeneric) {
            if (currentFamilyName) {
                if (relationship === 'parent' || relationship === 'sibling') {
                    return `${currentFamilyName} ???`;
                }
                else if (relationship === 'spouse') {
                    return 'Unknown Spouse';
                }
                else if (relationship === 'child') {
                    return `${currentFamilyName} ???`;
                }
            }
            return 'Unknown Relative';
        }
        
        const patterns = [
            /template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)_(?:hero_)?(?:fire|earth|water|wood|metal|nanman)$/,
            /template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)$/,
            /ironic_template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)_(?:hero_)?(?:fire|earth|water|wood|metal|nanman)$/,
            /ironic_template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)$/,
        ];
        
        for (const pattern of patterns) {
            const match = templateKey.match(pattern);
            if (match) {
                const name = match[1].replace(/_/g, ' ');
                return name.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
            }
        }
        
        return templateKey.replace(/^.*template_/, '').replace(/_/g, ' ');
    }

    // Gender-aware relationship label helper
    function getRelationshipLabel(relationship, targetCharacter, isTargetMissing = false) {
        // If we don't have character data, use default labels
        if (isTargetMissing || !targetCharacter) {
            const defaultLabels = {
                'parent': 'Parent',
                'child': 'Child',
                'spouse': 'Spouse',
                'sibling': 'Sibling',
                'grandparent': 'Grandparent',
                'grandchild': 'Grandchild',
                'uncle': 'Uncle/Aunt',
                'aunt': 'Uncle/Aunt',
                'nephew': 'Nephew/Niece',
                'niece': 'Nephew/Niece',
                'cousin': 'Cousin'
            };
            return defaultLabels[relationship] || relationship.charAt(0).toUpperCase() + relationship.slice(1);
        }
        
        // Check character's gender
        const isMale = targetCharacter.is_male !== false; // Default to male if not specified
        
        // Gender-specific labels
        const genderLabels = {
            'parent': isMale ? 'Father' : 'Mother',
            'child': isMale ? 'Son' : 'Daughter',
            'spouse': isMale ? 'Husband' : 'Wife',
            'sibling': isMale ? 'Brother' : 'Sister',
            'grandparent': isMale ? 'Grandfather' : 'Grandmother',
            'grandchild': isMale ? 'Grandson' : 'Granddaughter',
            'uncle': 'Uncle',
            'aunt': 'Aunt',
            'nephew': 'Nephew',
            'niece': 'Niece',
            'cousin': 'Cousin' // Cousin is gender-neutral
        };
        
        return genderLabels[relationship] || relationship.charAt(0).toUpperCase() + relationship.slice(1);
    }

    function renderFamilyMember(character, relationshipType, isMissing = false) {
        const relationLabel = getRelationshipLabel(relationshipType, character, isMissing);
        
        if (isMissing) {
            return `
                <div class="family-member family-member-missing"
                     title="${character.display_name} (No character data available)">
                    <span class="relationship-label">${relationLabel}</span>
                    <div class="family-portrait no-portrait">
                    </div>
                    <div class="family-member-name">
                        ${escapeHtml(character.display_name)}
                    </div>
                </div>
            `;
        }
        
        const details = (typeof CHARACTER_DETAILS_LOOKUP !== 'undefined')
            ? (CHARACTER_DETAILS_LOOKUP[character.key] || null)
            : null;
        
        const portraitUrl = details?.portrait?.url || '';

        return `
            <a href="character.html?key=${encodeURIComponent(character.key)}" 
               class="family-member"
               title="View ${character.display_name}'s page">
                <span class="relationship-label">${relationLabel}</span>
                <div class="family-portrait ${!portraitUrl ? 'no-portrait' : ''}"
                     ${portraitUrl ? `style="background-image: url('${escapeHtml(portraitUrl)}')"` : ''}>
                </div>
                <div class="family-member-name">
                    ${escapeHtml(character.display_name)}
                    ${character.display_name_alt ? `<br><span style="font-size: 0.65rem; opacity: 0.8;">${escapeHtml(character.display_name_alt)}</span>` : ''}
                </div>
            </a>
        `;
    }

    function renderFamilyTreeContent(char) {
        const hasUidData = (typeof FAMILY_BY_UID !== 'undefined') && (typeof TEMPLATE_TO_UIDS !== 'undefined');
        const hasTemplateData = (typeof FAMILY_BY_TEMPLATE !== 'undefined');
        const hasLegacyData = (typeof FAMILY_BY_CHARACTER !== 'undefined');

        if (!hasUidData && !hasTemplateData && !hasLegacyData) {
            return '<div class="family-tree-empty">Family tree data not available.</div>';
        }

        let familyMembers = null;

        // Preferred path (new JS export): resolve to a UID for correctness, but keep templates for navigation.
        if (hasUidData) {
            const details = (typeof CHARACTER_DETAILS_LOOKUP !== 'undefined')
                ? (CHARACTER_DETAILS_LOOKUP[char.key] || null)
                : null;

            // Try to use template_id from details if your CHARACTER_DETAILS exports it
            let uid = details && (details.template_id || details.templateId || details.templateID) ? String(details.template_id || details.templateId || details.templateID) : null;

            // Fallback: if we only have template key, pick the (only) UID for that template.
            if (!uid) {
                const uids = (TEMPLATE_TO_UIDS && TEMPLATE_TO_UIDS[char.key]) ? TEMPLATE_TO_UIDS[char.key] : [];
                if (uids.length > 0) uid = uids[0]; // if multiple, first is the best available guess
            }

            if (uid && FAMILY_BY_UID[uid]) {
                familyMembers = FAMILY_BY_UID[uid];
            }

            // Safety fallback: template-level relationships (may merge instances, but better than empty)
            if ((!familyMembers || familyMembers.length === 0) && hasTemplateData) {
                familyMembers = FAMILY_BY_TEMPLATE[char.key] || null;
            }
        }
        // New export, but without UID index available for some reason
        else if (hasTemplateData) {
            familyMembers = FAMILY_BY_TEMPLATE[char.key] || null;
        }
        // Legacy export (template#id keys)
        else if (hasLegacyData) {
            // Best-effort legacy resolution: direct, then match "template#id" prefix
            if (FAMILY_BY_CHARACTER[char.key]) {
                familyMembers = FAMILY_BY_CHARACTER[char.key];
            } else {
                for (const key in FAMILY_BY_CHARACTER) {
                    const templatePart = key.includes('#') ? key.split('#')[0] : key;
                    if (templatePart === char.key) {
                        familyMembers = FAMILY_BY_CHARACTER[key];
                        break;
                    }
                }
            }
        }

        if (!familyMembers || familyMembers.length === 0) {
            return '<div class="family-tree-empty">No known family relationships for this character.</div>';
        }

const grouped = {
            parent: [],
            spouse: [],
            sibling: [],
            child: [],
            grandparent: [],
            grandchild: [],
            uncle: [],
            aunt: [],
            nephew: [],
            niece: [],
            cousin: []
        };

        familyMembers.forEach(rel => {
            // Resolve related template (new export uses related_template; legacy uses related_to)
            const relatedTemplate = rel.related_template || (rel.related_to ? (rel.related_to.includes('#') ? rel.related_to.split('#')[0] : rel.related_to) : '');
            
            // Try to find the character in CHARACTER_DATA using just the template
            const relatedChar = CHARACTER_DATA.find(c => c.key === relatedTemplate);
            
            if (relatedChar) {
                grouped[rel.relationship] = grouped[rel.relationship] || [];
                grouped[rel.relationship].push({
                    character: relatedChar,
                    relationship: rel.relationship,
                    isMissing: false
                });
            } else {
                // Create placeholder for missing character
                const placeholderChar = {
                    key: relatedTemplate || rel.related_to,
                    display_name: extractNameForMissingCharacter(relatedTemplate || rel.related_to, char.family_name, rel.relationship),
                    name_key: rel.related_name || '',
                    is_male: null // Unknown gender for missing characters
                };
                
                grouped[rel.relationship] = grouped[rel.relationship] || [];
                grouped[rel.relationship].push({
                    character: placeholderChar,
                    relationship: rel.relationship,
                    isMissing: true
                });
            }
        });

        // Build the HTML for immediate family
        let immediateHTML = '';
        const immediateOrder = [
            { key: 'parent', label: 'Parents' },
            { key: 'spouse', label: 'Spouses' },
            { key: 'sibling', label: 'Siblings' },
            { key: 'child', label: 'Children' }
        ];

        immediateOrder.forEach(relType => {
            const members = grouped[relType.key];
            if (members && members.length > 0) {
                immediateHTML += `
                    <div class="family-group">
                        <div class="family-group-title">${relType.label}</div>
                        <div class="family-members">
                            ${members.map(m => 
                                renderFamilyMember(m.character, relType.key, m.isMissing)
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        });

        // Build the HTML for extended family
        let extendedHTML = '';
        const extendedTypes = [
            { key: 'grandparent', label: 'Grandparents' },
            { key: 'grandchild', label: 'Grandchildren' },
            { key: 'uncle', label: 'Uncles' },
            { key: 'aunt', label: 'Aunts' },
            { key: 'nephew', label: 'Nephews' },
            { key: 'niece', label: 'Nieces' },
            { key: 'cousin', label: 'Cousins' }
        ];

        let hasExtendedFamily = false;
        extendedTypes.forEach(relType => {
            const members = grouped[relType.key];
            if (members && members.length > 0) {
                hasExtendedFamily = true;
                extendedHTML += `
                    <div class="family-group">
                        <div class="family-group-title">${relType.label}</div>
                        <div class="family-members">
                            ${members.map(m => 
                                renderFamilyMember(m.character, relType.key, m.isMissing)
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        });

        let finalHTML = `
            <h3 class="family-tree-header">Family Tree</h3>
            <div class="family-connections">
                ${immediateHTML || '<p class="no-content">No immediate family members found.</p>'}
            </div>
        `;

        if (hasExtendedFamily) {
            finalHTML += `
                <div class="extended-family-section">
                    <h3 class="extended-family-header">Extended Family</h3>
                    <div class="family-connections">
                        ${extendedHTML}
                    </div>
                </div>
            `;
        }

        return finalHTML;
    }

    /* =========================
       Skill Tree helpers
       ========================= */

    const SKILL_ICON_BASE = 'data/images/skills/';

    function getSkillTree(skillSetKey) {
      if (!skillSetKey) return null;
      if (typeof SKILL_TREE_DATA !== 'undefined' && SKILL_TREE_DATA[skillSetKey]) {
        return SKILL_TREE_DATA[skillSetKey];
      }
      return null;
    }

    function renderSkillNode(node, x, y, isRightSide, isTopRow) {
      const title = node.title || node.skill_key || 'Unknown Skill';
      const desc = node.description || '';
      const imageUrl = node.image || '';
      const effects = node.effects || [];
      const isUnlocked = node.points_on_creation > 0;

      // Build effects HTML
      let effectsHtml = '';
      if (effects.length > 0) {
        const formattedEffects = effects
          .filter(e => e.formatted)
          .map(e => `<div class="skill-tooltip-effect">${escapeHtml(e.formatted)}</div>`)
          .join('');
        
        if (formattedEffects) {
          effectsHtml = `
            <div class="skill-tooltip-effects">
              <div class="skill-tooltip-effects-header">Effects</div>
              ${formattedEffects}
            </div>
          `;
        }
      }

      // Meta info
      const metaHtml = `
        <div class="skill-tooltip-meta">
          <span>Tier: ${node.tier}</span>
          <span>Indent: ${node.indent}</span>
          ${node.game_mode ? `<span>Mode: ${escapeHtml(node.game_mode)}</span>` : ''}
        </div>
      `;

      // Build CSS classes
      const classes = ['skill-node'];
      if (isUnlocked) classes.push('unlocked');
      if (!isUnlocked) classes.push('locked');
      if (isRightSide) classes.push('tooltip-left');
      if (isTopRow) classes.push('tooltip-below');

      return `
        <div class="${classes.join(' ')}" 
             style="left: ${x}px; top: ${y}px;"
             data-skill-key="${escapeHtml(node.skill_key)}"
             data-node-key="${escapeHtml(node.key)}"
             data-tier="${node.tier}"
             data-indent="${node.indent}"
             data-game-mode="${escapeHtml(node.game_mode || '')}">
          ${imageUrl 
            ? `<img class="skill-node-icon" src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" onerror="this.outerHTML='<div class=\\'skill-node-icon placeholder\\'>${escapeHtml((title[0] || '?').toUpperCase())}</div>';">`
            : `<div class="skill-node-icon placeholder">${escapeHtml((title[0] || '?').toUpperCase())}</div>`
          }
          <div class="skill-tooltip">
            <div class="skill-tooltip-title">${escapeHtml(title)}</div>
            ${desc ? `<div class="skill-tooltip-desc">${escapeHtml(desc)}</div>` : ''}
            ${effectsHtml}
            ${metaHtml}
          </div>
        </div>
      `;
    }

    function renderSkillTreeContent(char) {
      const skillSetKey = char.skill_set;
      
      if (!skillSetKey) {
        return '<div class="skill-tree-empty">No skill set assigned to this character.</div>';
      }

      const skillTree = getSkillTree(skillSetKey);
      
      if (!skillTree || !skillTree.nodes || skillTree.nodes.length === 0) {
        return `<div class="skill-tree-empty">Skill tree data not available for: ${escapeHtml(skillSetKey)}</div>`;
      }

      // Filter visible nodes
      const visibleNodes = skillTree.nodes.filter(node => node.visible_in_ui !== false);
      
      if (visibleNodes.length === 0) {
        return `<div class="skill-tree-empty">No visible skills in this skill tree.</div>`;
      }

      // Check if there are different game modes
      const gameModes = [...new Set(visibleNodes.map(n => n.game_mode).filter(m => m))];
      const hasMultipleModes = gameModes.length > 1 || 
        gameModes.some(m => m.toLowerCase().includes('romance') || m.toLowerCase().includes('historical'));

      // Calculate grid dimensions
      const tiers = [...new Set(visibleNodes.map(n => n.tier))].sort((a, b) => a - b);
      const indents = [...new Set(visibleNodes.map(n => n.indent))].sort((a, b) => a - b);
      
      const minTier = Math.min(...tiers);
      const maxTier = Math.max(...tiers);
      const minIndent = Math.min(...indents);
      const maxIndent = Math.max(...indents);

      // Layout settings
      const nodeSize = 64;
      const paddingLeft = 60;  // Space for row labels
      const paddingTop = 50;
      const paddingRight = 60;
      const paddingBottom = 50;
      
      // Calculate spacing based on indent range
      const indentRange = maxIndent - minIndent || 1;
      const tierRange = maxTier - minTier || 1;
      
      // Horizontal spacing: map indent values to x positions
      const gridWidth = Math.max(550, indents.length * 110);
      const xScale = (gridWidth - nodeSize) / indentRange;
      
      // Vertical spacing: map tier values to y positions
      const rowHeight = 110;
      const gridHeight = (tierRange + 1) * rowHeight;

      // Calculate node positions
      const nodePositions = {};
      visibleNodes.forEach(node => {
        const x = paddingLeft + ((node.indent - minIndent) * xScale) + (nodeSize / 2);
        const y = paddingTop + ((node.tier - minTier) * rowHeight) + (nodeSize / 2);
        nodePositions[node.key] = { x, y, node };
      });

      // Build SVG lines for connections
      let linesHtml = '';
      visibleNodes.forEach(node => {
        const pos = nodePositions[node.key];
        if (!pos) return;

        // Draw lines to children (parent -> child direction)
        const children = node.links?.children || [];
        children.forEach(child => {
          const childPos = nodePositions[child.key];
          if (childPos) {
            const isUnlocked = node.points_on_creation > 0 && childPos.node.points_on_creation > 0;
            // Add game mode data to lines for filtering
            const lineGameMode = node.game_mode || childPos.node.game_mode || '';
            const gameModeAttr = lineGameMode ? `data-game-mode="${escapeHtml(lineGameMode)}"` : '';
            linesHtml += `<line x1="${pos.x}" y1="${pos.y}" x2="${childPos.x}" y2="${childPos.y}" class="${isUnlocked ? 'unlocked' : ''}" ${gameModeAttr}/>`;
          }
        });

        // Also draw lines to parents (for bidirectional visibility)
        const parents = node.links?.parents || [];
        parents.forEach(parent => {
          const parentPos = nodePositions[parent.key];
          if (parentPos) {
            // Check if this line was already drawn from parent's perspective
            const alreadyDrawn = parentPos.node.links?.children?.some(c => c.key === node.key);
            if (!alreadyDrawn) {
              const isUnlocked = node.points_on_creation > 0 && parentPos.node.points_on_creation > 0;
              const lineGameMode = node.game_mode || parentPos.node.game_mode || '';
              const gameModeAttr = lineGameMode ? `data-game-mode="${escapeHtml(lineGameMode)}"` : '';
              linesHtml += `<line x1="${parentPos.x}" y1="${parentPos.y}" x2="${pos.x}" y2="${pos.y}" class="${isUnlocked ? 'unlocked' : ''}" ${gameModeAttr}/>`;
            }
          }
        });
      });

      // Build nodes HTML
      const canvasWidth = gridWidth + paddingLeft + paddingRight;
      const canvasHeight = gridHeight + paddingTop + paddingBottom;
      const midPoint = canvasWidth / 2;

      let nodesHtml = '';
      visibleNodes.forEach(node => {
        const pos = nodePositions[node.key];
        if (!pos) return;
        const isRightSide = pos.x > midPoint;
        const isTopRow = node.tier === minTier;
        nodesHtml += renderSkillNode(node, pos.x, pos.y, isRightSide, isTopRow);
      });

      // Build tier row labels
      let rowLabelsHtml = '';
      tiers.forEach(tier => {
        const y = paddingTop + ((tier - minTier) * rowHeight) + (nodeSize / 2);
        rowLabelsHtml += `<div class="skill-tree-row-label" style="top: ${y}px;">${tier}</div>`;
      });

      // Build game mode toggle if needed
      let modeToggleHtml = '';
      if (hasMultipleModes) {
        modeToggleHtml = `
          <div class="skill-tree-mode-toggle">
            <button class="skill-tree-mode-btn active" data-mode="all">All</button>
            <button class="skill-tree-mode-btn" data-mode="romance">Romance</button>
            <button class="skill-tree-mode-btn" data-mode="historical">Historical</button>
          </div>
        `;
      }

      return `
        <h3 class="skill-tree-header">Skill Tree</h3>
        <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">
          Skill Set: <code style="background: rgba(255,255,255,0.04); padding: 0.1rem 0.3rem; border-radius: 2px;">${escapeHtml(skillSetKey)}</code>
        </p>
        ${modeToggleHtml}
        <div class="skill-tree-grid">
          <div class="skill-tree-canvas" id="skill-tree-canvas" data-mode="all" style="width: ${canvasWidth}px; height: ${canvasHeight}px;">
            <svg class="skill-tree-links" width="${canvasWidth}" height="${canvasHeight}">
              ${linesHtml}
            </svg>
            <div class="skill-tree-row-labels">
              ${rowLabelsHtml}
            </div>
            <div class="skill-tree-nodes">
              ${nodesHtml}
            </div>
          </div>
        </div>
      `;
    }

    function initSkillTreeModeToggle() {
      const toggleBtns = document.querySelectorAll('.skill-tree-mode-btn');
      const canvas = document.getElementById('skill-tree-canvas');
      
      if (!toggleBtns.length || !canvas) return;

      toggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active button
          toggleBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Update canvas filter
          const mode = btn.getAttribute('data-mode');
          canvas.setAttribute('data-mode', mode);
          
          // Show/hide nodes based on mode
          const nodes = canvas.querySelectorAll('.skill-node');
          const lines = canvas.querySelectorAll('.skill-tree-links line');
          
          nodes.forEach(node => {
            const nodeMode = (node.getAttribute('data-game-mode') || '').toLowerCase();
            if (mode === 'all') {
              node.style.display = '';
            } else if (mode === 'romance') {
              // Show if no mode specified, or if mode contains 'romance'
              const show = !nodeMode || nodeMode.includes('romance') || (!nodeMode.includes('historical'));
              node.style.display = nodeMode.includes('historical') && !nodeMode.includes('romance') ? 'none' : '';
            } else if (mode === 'historical') {
              // Show if no mode specified, or if mode contains 'historical'
              node.style.display = nodeMode.includes('romance') && !nodeMode.includes('historical') ? 'none' : '';
            }
          });
          
          // Also hide lines connected to hidden nodes
          lines.forEach(line => {
            const lineMode = (line.getAttribute('data-game-mode') || '').toLowerCase();
            if (mode === 'all') {
              line.style.display = '';
            } else if (mode === 'romance') {
              line.style.display = lineMode.includes('historical') && !lineMode.includes('romance') ? 'none' : '';
            } else if (mode === 'historical') {
              line.style.display = lineMode.includes('romance') && !lineMode.includes('historical') ? 'none' : '';
            }
          });
        });
      });
    }

    /* =========================
       Main render functions
       ========================= */
    
    // [Rest of the code remains the same - renderCharacter, categorizeEffects, renderEffects, renderNotFound, and initialization]
    
    function renderCharacter(char) {
      const details = (typeof CHARACTER_DETAILS_LOOKUP !== 'undefined')
        ? (CHARACTER_DETAILS_LOOKUP[char.key] || null)
        : null;

      const biography = (typeof CHARACTER_BIOS_LOOKUP !== 'undefined')
        ? (CHARACTER_BIOS_LOOKUP[char.key] || '')
        : '';

      document.title = `${char.display_name} | 190 Expanded Wiki`;

      const element = (char.element || 'unknown').toLowerCase();
      const portraitUrl = details?.portrait?.url || '';
      const effects = Array.isArray(details?.effects) ? details.effects : [];

      // Traits: prefer details.traits, fallback to char.traits
      const traits = Array.isArray(details?.traits) ? details.traits : (Array.isArray(char?.traits) ? char.traits : []);

      // Format birth/death years
      let dateStr = '';
      if (char.birth_year) {
        dateStr = `${char.birth_year} AD`;
        if (char?.death_year) {
          dateStr += ` – ${char.death_year} AD`;
        } else {
          dateStr += ' – ???';
        }
      }

      const root = document.getElementById('character-root');
      root.setAttribute('data-element', element);

      root.innerHTML = `
        <!-- Left Content Area -->
        <div class="content-area">
          <!-- Row 1: Title/Desc + Name/Info -->
          <div class="row-top">
            <!-- Title & Description -->
            <div class="panel panel-divider-right panel-divider-bottom title-panel">
              ${char.title
                ? `<h2 class="char-title" data-element="${escapeHtml(element)}">
                    ${escapeHtml(char.title)}
                  </h2>
                  `
                : ''
              }
              ${char.description
                ? `<p class="char-description">${escapeHtml(char.description)}</p>`
                : ''
              }
              ${!char.title && !char.description
                ? `<p class="no-title-desc">No title or description available.</p>`
                : ''
              }
            </div>

            <!-- Name & Info -->
            <div class="panel panel-divider-bottom info-panel">
              <h1>
                ${escapeHtml(char.display_name)}
                ${char.display_name_alt ? `<span class="chinese-name">${escapeHtml(char.display_name_alt)}</span>` : ''}
              </h1>
              ${char.courtesy_name ? `
                <p class="courtesy-name">
                  <span class="courtesy-label">Courtesy Name:</span> 
                  ${escapeHtml(char.courtesy_name)}
                  ${char.courtesy_name_alt ? `<span class="chinese-text">${escapeHtml(char.courtesy_name_alt)}</span>` : ''}
                </p>
              ` : ''}
              ${dateStr ? `<p class="char-dates">${escapeHtml(dateStr)}</p>` : ''}
              <div class="char-tags">
                <span class="tag ${char.is_unique ? 'unique' : 'generic'}">
                  ${char.is_unique ? 'Unique' : 'Generic'}
                </span>
                <span class="tag ${char.is_male ? 'male' : 'female'}">
                  ${char.is_male ? 'Male' : 'Female'}
                </span>
                <span class="tag element">
                  ${escapeHtml(element)}
                </span>
              </div>
            </div>
          </div>

          <!-- Row 2: Bio + Effects -->
          <div class="row-bottom">
            <!-- Biography -->
            <div class="panel panel-divider-right bio-panel">
              <h3 class="panel-header">Biography</h3>
              ${biography.trim()
                ? `<p class="bio-text">${escapeHtml(biography)}</p>`
                : `<p class="no-content">No biography available for this character.</p>`
              }

              <!-- Technical Details -->
              <details class="tech-details">
                <summary>Technical Details</summary>
                <dl>
                  <dt>Template Key</dt>
                  <dd><code>${escapeHtml(char.key)}</code></dd>
                  <dt>Name Key</dt>
                  <dd><code>${escapeHtml(char.name_key || '')}</code></dd>
                  <dt>Subtype</dt>
                  <dd>${escapeHtml(char.subtype || 'N/A')}</dd>
                  <dt>Forename</dt>
                  <dd>${escapeHtml(char.forename || 'N/A')} ${char.forename_alt ? `(${escapeHtml(char.forename_alt)})` : ''}</dd>
                  <dt>Family Name</dt>
                  <dd>${escapeHtml(char.family_name || 'N/A')} ${char.family_name_alt ? `(${escapeHtml(char.family_name_alt)})` : ''}</dd>
                  ${char.courtesy_name ? `
                    <dt>Courtesy</dt>
                    <dd>${escapeHtml(char.courtesy_name)} ${char.courtesy_name_alt ? `(${escapeHtml(char.courtesy_name_alt)})` : ''}</dd>
                  ` : ''}
                  ${char.skill_set ? `
                    <dt>Skill Set</dt>
                    <dd><code>${escapeHtml(char.skill_set)}</code></dd>
                  ` : ''}
                </dl>
              </details>
            </div>

            <!-- Effects -->
            <div class="panel effects-panel">
              <h3 class="panel-header">Effects</h3>
              <div id="effects-container"></div>
            </div>
          </div>
        </div>

        <!-- Right Portrait Column -->
        <div class="portrait-column" id="portrait-column" ${portraitUrl ? `style="background-image: url('${escapeHtml(portraitUrl)}')"` : ''}>
          ${portraitUrl ? '<button class="portrait-toggle" id="portrait-toggle" title="Toggle fit mode">Fit</button>' : ''}
          ${!portraitUrl ? '<div class="no-portrait-placeholder">No Portrait Available</div>' : ''}
          <div class="trait-strip" id="trait-strip"></div>
        </div>
      `;

      // Render categorized effects
      renderEffects(effects);

      // Render traits (icons next to portrait)
      renderTraitsIntoPortrait(traits);

      // Render tabs section
      const tabsSection = document.getElementById('tabs-section');
      tabsSection.style.display = 'block';
      tabsSection.setAttribute('data-element', element);

      // Render Family Tree tab content
      const familyTreeTab = document.getElementById('tab-family-tree');
      familyTreeTab.innerHTML = renderFamilyTreeContent(char);

      // Render Skills tab content
      const skillsTab = document.getElementById('tab-skills');
      skillsTab.innerHTML = renderSkillTreeContent(char);

      // Initialize tabs
      initTabs();

      // Initialize skill tree mode toggle
      initSkillTreeModeToggle();

      // Portrait toggle functionality
      if (portraitUrl) {
        const portraitCol = document.getElementById('portrait-column');
        const toggleBtn = document.getElementById('portrait-toggle');

        const img = new Image();
        img.onload = function() {
          const imgRatio = img.width / img.height;
          if (imgRatio > 1.2 || imgRatio < 0.4) {
            portraitCol.classList.add('contain-mode');
            toggleBtn.textContent = 'Fill';
          }
        };
        img.src = portraitUrl;

        toggleBtn.addEventListener('click', function() {
          portraitCol.classList.toggle('contain-mode');
          toggleBtn.textContent = portraitCol.classList.contains('contain-mode') ? 'Fill' : 'Fit';
        });
      }
    }

    function categorizeEffects(effects) {
      const categories = {
        attributes: { label: 'Attributes', items: [], order: 1 },
        lives: { label: 'Lives', items: [], order: 2 },
        wealth: { label: 'Wealth', items: [], order: 3 },
        ai_hint: { label: 'AI Hint', items: [], order: 4 },
        other: { label: 'Other', items: [], order: 5 }
      };

      const attributeKeywords = ['instinct', 'resolve', 'cunning', 'expertise', 'authority'];

      effects.forEach(eff => {
        const name = (eff.name || '').toLowerCase();

        if (attributeKeywords.some(attr => name.includes(attr))) {
          categories.attributes.items.push(eff);
        } else if (name.includes('lives') || name.includes('num_lives') || name.includes('life')) {
          categories.lives.items.push(eff);
        } else if (name.includes('wealth')) {
          categories.wealth.items.push(eff);
        } else if (name.includes('ai_hint') || name.includes('ai hint')) {
          categories.ai_hint.items.push(eff);
        } else {
          categories.other.items.push(eff);
        }
      });

      return categories;
    }

    function renderEffects(effects) {
      const container = document.getElementById('effects-container');

      if (!effects || effects.length === 0) {
        container.innerHTML = '<p class="no-content">No effects data available.</p>';
        return;
      }

      const categories = categorizeEffects(effects);
      const sortedCategories = Object.values(categories)
        .filter(cat => cat.items.length > 0)
        .sort((a, b) => a.order - b.order);

      if (sortedCategories.length === 0) {
        container.innerHTML = '<p class="no-content">No effects data available.</p>';
        return;
      }

      let html = '';
      sortedCategories.forEach(category => {
        html += `
          <div class="effect-category">
            <h4 class="effect-category-header">${escapeHtml(category.label)}</h4>
            <div class="effect-category-items">
              ${category.items.map(eff => {
                const name = eff.name || 'Effect';
                return `<div class="effect-item">${escapeHtml(name)}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderNotFound(key) {
      document.title = "Character not found | 190 Expanded Wiki";
      document.getElementById('character-root').innerHTML = `
        <div class="content-area" style="grid-column: 1 / -1;">
          <div class="panel title-panel" style="min-height: 200px;">
            <h2 class="char-title">Character Not Found</h2>
            <p class="char-description">No character exists with the key: <code>${escapeHtml(key)}</code></p>
          </div>
        </div>
      `;
    }

    // Initialize
    const params = new URLSearchParams(window.location.search);
    const key = params.get('key');

    if (!key) {
      renderNotFound('(no key provided)');
    } else {
      const char = (typeof CHARACTER_DATA !== 'undefined')
        ? CHARACTER_DATA.find(c => c.key === key)
        : null;

      if (!char) {
        renderNotFound(key);
      } else {
        renderCharacter(char);
      }
    }
  </script>
</body>
</html>