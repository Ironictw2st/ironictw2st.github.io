<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Character | 190 Expanded Wiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/tw3k.css" />

  <style>
    /* =========================
   Element Theme (Muted / TW-style)
   ========================= */

    .character-page {
      --theme: #9a8648; /* fallback: aged earth gold */
      --theme-soft: rgba(154, 134, 72, 0.16);
      --theme-glow: rgba(154, 134, 72, 0.22);
    }

    /* Muted element mappings */
    .character-page[data-element="water"] {
      --theme: #4f6f8f;
      --theme-soft: rgba(79, 111, 143, 0.16);
      --theme-glow: rgba(79, 111, 143, 0.22);
    }

    .character-page[data-element="wood"] {
      --theme: #4f7a55;
      --theme-soft: rgba(79, 122, 85, 0.16);
      --theme-glow: rgba(79, 122, 85, 0.22);
    }

    .character-page[data-element="fire"] {
      --theme: #8c3a3a;
      --theme-soft: rgba(140, 58, 58, 0.16);
      --theme-glow: rgba(140, 58, 58, 0.22);
    }

    .character-page[data-element="earth"] {
      --theme: #9a8648;
      --theme-soft: rgba(154, 134, 72, 0.16);
      --theme-glow: rgba(154, 134, 72, 0.22);
    }

    .character-page[data-element="metal"] {
      --theme: #7a6a99;
      --theme-soft: rgba(122, 106, 153, 0.16);
      --theme-glow: rgba(122, 106, 153, 0.22);
    }

    .character-page[data-element="nanman"] {
      --theme: #7f8f4a;
      --theme-soft: rgba(127, 143, 74, 0.16);
      --theme-glow: rgba(127, 143, 74, 0.22);
    }

     .trait-tooltip .t-effects {
       margin-top: 8px;
       padding-top: 8px;
       border-top: 1px solid rgba(255,255,255,0.10);
       display: flex;
       flex-direction: column;
       gap: 4px;
     }

     .trait-tooltip .t-effects-header {
       font-family: 'Cinzel', serif;
       font-size: 0.65rem;
       letter-spacing: 0.08em;
       text-transform: uppercase;
       color: rgba(255,255,255,0.70);
     }

     .trait-tooltip .t-effect {
       font-size: 0.8rem;
       color: rgba(255,255,255,0.80);
       line-height: 1.25;
       background: rgba(255,255,255,0.04);
       border-left: 2px solid rgba(255,255,255,0.18);
       padding: 2px 6px;
     }


    /* =========================
       Character Page Layout
       ========================= */

    .character-page {
      display: grid;
      grid-template-columns: 1.6fr 0.9fr;
      min-height: 800px;
      border: 1px solid #252530;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 0 18px var(--theme-glow);
    }

    /* Left content area */
    .content-area {
      display: flex;
      flex-direction: column;
    }

    /* Row 1: Title/Desc + Name/Dates */
    .row-top {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      border-bottom: 1px solid #252530;
    }

    /* Row 2: Bio + Effects */
    .row-bottom {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      flex: 1;
    }

    /* =========================
       Portrait column (right)
       ========================= */

    .portrait-column {
      background-color: #0a0a0c;
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      border-left: 1px solid #252530;
      position: relative;
      min-height: 500px;
      overflow: visible;
    }

    /* Contain mode - shows full image */
    .portrait-column.contain-mode {
      background-size: contain;
      background-position: center center;
    }

    .portrait-column::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(to top, rgba(10,10,12,0.9) 0%, transparent 100%);
      pointer-events: none;
    }

    .portrait-toggle {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--text-muted);
      padding: 0.3rem 0.5rem;
      font-size: 0.65rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }

    .portrait-toggle:hover {
      background: rgba(40,40,40,0.9);
      color: var(--text-secondary);
      border-color: rgba(255,255,255,0.28);
    }

    .no-portrait-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* =========================
       TRAITS (icons next to portrait)
       ========================= */

    .trait-strip {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 50;

      display: flex;
      flex-direction: column;  /* <-- vertical */
      flex-wrap: nowrap;        /* <-- no wrapping */
      gap: 8px;

      max-width: none;
      pointer-events: auto;
    }

    /* Make trait list vertical */
    #trait-strip.trait-strip {
      position: absolute;
      top: 12px;
      left: 12px;

      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 8px;

      z-index: 9998;          /* higher than basically everything */
      pointer-events: auto;
    }

    /* Ensure each icon can be hovered */
    #trait-strip .trait-icon {
      width: 42px;
      height: 42px;

      position: relative;
      z-index: 9999;          /* keep tooltip above portrait overlays */
      cursor: default;

      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);

      display: grid;
      place-items: center;
      overflow: visible;      /* critical: tooltip is a child */
    }

    /* Tooltip default: fully hidden */
    #trait-strip .trait-tooltip {
      position: absolute;
      left: calc(100% + 10px);  /* show to the right (best for vertical list) */
      top: 0;

      min-width: 260px;
      max-width: 360px;

      background: rgba(10,10,14,0.96);
      border: 1px solid #2a2a35;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.55);

      display: none;           /* <-- avoids opacity/z-index conflicts */
      visibility: hidden;
      opacity: 0;

      transform: translateX(-4px);
      transition: opacity 120ms ease, transform 120ms ease;

      z-index: 10000;
      pointer-events: none;    /* keeps hover stable */
    }

    /* Tooltip on hover: force show (wins over tw3k.css) */
    #trait-strip .trait-icon:hover > .trait-tooltip {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      transform: translateX(0) !important;
    }


    .trait-icon {
      width: 42px;
      height: 42px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);
      display: grid;
      place-items: center;
      overflow: hidden;
      position: relative;
      cursor: default;
    }

    .trait-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .trait-badge {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      font-family: 'Cinzel', serif;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: rgba(255,255,255,0.85);
      text-transform: uppercase;
      font-size: 0.8rem;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    .trait-tooltip {
      position: absolute;
      left: 0;
      top: calc(100% + 10px);
      min-width: 260px;
      max-width: 360px;
      background: rgba(10,10,14,0.96);
      border: 1px solid #2a2a35;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.55);
      opacity: 0;
      transform: translateY(-4px);
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
      z-index: 20;
    }

    .trait-icon:hover .trait-tooltip {
      opacity: 1;
      transform: translateY(0);
    }

    .trait-tooltip .t-title {
      font-family: 'Cinzel', serif;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.92);
      margin: 0 0 6px 0;
      line-height: 1.2;
    }

    .trait-tooltip .t-desc {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.75);
      margin: 0;
      line-height: 1.35;
      white-space: normal;
    }

    /* =========================
       Shared panel styling
       ========================= */

    .panel {
      background: var(--bg-card);
      padding: 1.5rem;
    }

    .panel-divider-right {
      border-right: 1px solid #252530;
    }

    .panel-divider-bottom {
      border-bottom: 1px solid #252530;
    }

    /* =========================
       Title/Description Panel
       ========================= */

    .title-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 180px;
      border-left: 4px solid var(--theme);
    }

    .char-title {
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color, var(--gold-primary));
      margin: 0 0 0.75rem 0;
      text-shadow: 0 0 6px var(--theme-glow, rgba(0,0,0,0.4));
    }

    /* Muted element mappings — char-title ONLY */
    .char-title[data-element="water"] { --color: #4f6f8f; --theme-glow: rgba(79, 111, 143, 0.22); }
    .char-title[data-element="wood"] { --color: #4f7a55; --theme-glow: rgba(79, 122, 85, 0.22); }
    .char-title[data-element="fire"] { --color: #8c3a3a; --theme-glow: rgba(140, 58, 58, 0.22); }
    .char-title[data-element="earth"] { --color: #9a8648; --theme-glow: rgba(154, 134, 72, 0.22); }
    .char-title[data-element="metal"] { --color: #7a6a99; --theme-glow: rgba(122, 106, 153, 0.22); }
    .char-title[data-element="nanman"] { --color: #7f8f4a; --theme-glow: rgba(127, 143, 74, 0.22); }

    .char-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 0;
      font-style: italic;
    }

    .no-title-desc {
      color: var(--text-muted);
      font-style: italic;
    }

    /* =========================
       Name/Info Panel
       ========================= */

    .info-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 180px;
    }

    .info-panel h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--title-cream);
      margin: 0 0 0.2rem 0;
    }

    .chinese-name {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-left: 0.5rem;
      font-weight: normal;
      opacity: 0.8;
    }

    .courtesy-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0.75rem 0;
    }

    .courtesy-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-right: 0.5rem;
    }

    .chinese-text {
      margin-left: 0.5rem;
      opacity: 0.8;
    }

    .char-dates {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 1rem 0;
    }

    .char-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid #353530;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tag.unique { border-color: var(--gold-dark); color: var(--gold-light); }
    .tag.generic { border-color: #353530; }
    .tag.male { border-color: #6b8cae; color: #8ab4d9; }
    .tag.female { border-color: #9966cc; color: #cc99ff; }

    .tag.element {
      background: rgba(0,0,0,0.25);
      border-color: var(--theme);
      color: var(--theme);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }

    /* =========================
       Bio Panel
       ========================= */

    .bio-panel {
      min-height: 250px;
    }

    .panel-header {
      font-family: 'Cinzel', serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .bio-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.8;
      margin: 0;
      white-space: pre-wrap;
    }

    .no-content {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.85rem;
    }

    /* =========================
       Effects Panel
       ========================= */

    .effects-panel {
      min-height: 250px;
      background: rgba(0,0,0,0.15);
    }

    .effect-category { margin-bottom: 1rem; }
    .effect-category:last-child { margin-bottom: 0; }

    .effect-category-header {
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--theme);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 0.4rem 0;
      padding-bottom: 0.15rem;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .effect-category-items {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .effect-item {
      font-size: 0.8rem;
      color: var(--text-secondary);
      padding: 0.15rem 0.25rem;
      background: rgba(255,255,255,0.03);
      border-left: 2px solid rgba(255,255,255,0.18);
    }

    .effect-category:nth-child(1) .effect-item { border-left-color: var(--theme); }
    .effect-category:nth-child(2) .effect-item { border-left-color: rgba(196,30,58,0.55); }
    .effect-category:nth-child(3) .effect-item { border-left-color: rgba(34,139,34,0.55); }
    .effect-category:nth-child(4) .effect-item { border-left-color: rgba(65,105,225,0.55); }
    .effect-category:nth-child(5) .effect-item { border-left-color: rgba(255,255,255,0.18); }

    /* =========================
       Technical Details
       ========================= */

    .tech-details {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #252530;
    }

    .tech-details summary {
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      padding: 0.5rem 0;
    }

    .tech-details dl {
      margin: 1rem 0 0 0;
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 0.3rem 0.75rem;
      font-size: 0.75rem;
    }

    .tech-details dt { color: var(--text-muted); }
    .tech-details dd {
      margin: 0;
      color: var(--text-secondary);
      word-break: break-all;
    }

    .tech-details code {
      font-size: 0.7rem;
      color: var(--gold-primary);
    }

    /* =========================
       Family Tree Section
       ========================= */
    
    .family-tree-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--bg-card);
        border: 1px solid #252530;
    }

    .family-tree-header {
        font-family: 'Cinzel', serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--theme);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .family-members {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        justify-content: center;
    }

    .family-group { margin-bottom: 2rem; }
    .family-group:last-child { margin-bottom: 0; }

    .family-group-title {
        font-family: 'Cinzel', serif;
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        text-align: center;
        margin-bottom: 1rem;
    }

    .family-member {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        position: relative;
    }

    .family-member:hover { transform: translateY(-4px); }

    .family-member-missing {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: not-allowed;
        opacity: 0.7;
        position: relative;
    }

    .family-member-missing .family-portrait {
        border-style: dashed;
        border-color: #404045;
    }

    .family-member-missing .family-portrait.no-portrait::after {
        content: '—';
        font-size: 1.5rem;
        color: var(--text-muted);
        opacity: 0.5;
    }

    .family-member-missing .family-member-name {
        font-style: italic;
        color: var(--text-muted);
    }

    .family-member-missing:hover { transform: none; }

    .family-member-missing .family-portrait:hover {
        border-color: #404045;
        box-shadow: none;
    }

    .family-portrait {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #0a0a0c;
        background-size: cover;
        background-position: center top;
        border: 2px solid #252530;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .family-member:hover .family-portrait {
        border-color: var(--theme);
        box-shadow: 0 0 12px var(--theme-glow);
    }

    .family-portrait.no-portrait {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a1a1d 0%, #0a0a0c 100%);
    }

    .family-portrait.no-portrait::after {
        content: '?';
        font-family: 'Cinzel', serif;
        font-size: 1.8rem;
        color: var(--text-muted);
    }

    .family-member-name {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: center;
        max-width: 100px;
        line-height: 1.2;
    }

    .family-member:hover .family-member-name { color: var(--title-cream); }

    .relationship-label {
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.6rem;
        padding: 0.1rem 0.4rem;
        background: var(--bg-card);
        border: 1px solid #252530;
        color: var(--theme);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        z-index: 1;
    }

    .family-tree-empty {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .family-connections {
        position: relative;
        padding: 2rem 0;
    }

    /* Extended family section */
    .extended-family-section {
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }

    .extended-family-header {
        font-family: 'Cinzel', serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--theme);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        opacity: 0.8;
    }

    /* =========================
       Responsive
       ========================= */

    @media (max-width: 1000px) {
      .character-page { grid-template-columns: 1fr; }

      .portrait-column {
        min-height: 300px;
        order: -1;
      }

      .row-top, .row-bottom { grid-template-columns: 1fr; }

      .panel-divider-right {
        border-right: none;
        border-bottom: 1px solid #252530;
      }

      .family-members { gap: 1rem; }
      .family-portrait { width: 60px; height: 60px; }
    }
  </style>
</head>

<body>
  <div class="page-bg"></div>

  <header>
    <nav class="top-nav">
      <a href="../index.html" class="back-link">← Back to Hub</a>
    </nav>
    <div class="header-content">
      <p class="subtitle">190 Expanded Wiki</p>
      <h1>Character</h1>
    </div>
  </header>

  <nav class="main-nav">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="factions.html">Factions</a></li>
      <li><a href="characters.html" class="active">Characters</a></li>
      <li><a href="guides.html">Guides</a></li>
      <li><a href="changelog.html">Changelog</a></li>
    </ul>
  </nav>

  <main>
    <a class="back-link" href="characters.html" style="margin-bottom: 1rem; display: inline-block;">← Back to Characters</a>
    <section id="character-root" class="character-page"></section>
    <section id="family-tree-root"></section>
  </main>

  <footer>
    <p>190 Expanded Wiki · Created by Ironic</p>
  </footer>

  <script src="data/characters.js"></script>
  <script src="data/character_details.js"></script>
  <script src="data/character_bios.js"></script>
  <script src="data/family_tree.js"></script>
  <script src="data/traits.js"></script>

  <script>
    function escapeHtml(s) {
      return String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /* =========================
       Traits helpers
       ========================= */

    // Your site-relative path to trait icon folder:
    // (Windows path: total_war\data\UI\Campaign UI\traits)
    // becomes (web path): data/UI/Campaign UI/traits
    // NOTE: spaces must be URL-encoded when used in href/src.
    const TRAIT_ICON_BASE = 'data/UI/Campaign%20UI/traits/';

    function getTraitObject(traitKey) {
      if (!traitKey) return null;
      if (typeof TRAIT_LOOKUP !== 'undefined' && TRAIT_LOOKUP && TRAIT_LOOKUP[traitKey]) return TRAIT_LOOKUP[traitKey];
      if (typeof TRAIT_DATA !== 'undefined' && Array.isArray(TRAIT_DATA)) {
        return TRAIT_DATA.find(t => t && t.key === traitKey) || null;
      }
      return null;
    }

    function normalizeIconCandidates(iconPath) {
      const out = [];
      const pRaw = String(iconPath || '')
        .replace(/^[\\/]+/, '')
        .replace(/\\/g, '/')
        .replace(/^\/+/, '');

      if (!pRaw) return out;

      // If icon_path already contains the full traits folder path, use as-is (after encoding spaces).
      // If it's just a filename, we join it with TRAIT_ICON_BASE.
      const p = encodeURI(pRaw); // encodes spaces etc but keeps slashes

      // 1) Direct path (relative to site root)
      out.push(p.endsWith('.png') || p.endsWith('.webp') ? p : (p + '.png'));
      out.push(p.endsWith('.png') || p.endsWith('.webp') ? p : (p + '.webp'));

      // 2) Base folder + leaf filename
      const leaf = encodeURIComponent(pRaw.split('/').pop() || '');
      if (leaf) {
        out.push(TRAIT_ICON_BASE + leaf);        // if leaf already includes extension
        out.push(TRAIT_ICON_BASE + leaf + '.png');
        out.push(TRAIT_ICON_BASE + leaf + '.webp');
      }

      // 3) If it starts with ui/, try mapping to your data/UI/... tree
      // Example: ui/campaign ui/traits/foo -> data/UI/Campaign UI/traits/foo
      const lower = pRaw.toLowerCase();
      if (lower.startsWith('ui/')) {
        const afterUi = pRaw.slice(3); // remove "ui/"
        // attempt: data/UI/<afterUi>
        const mapped = 'data/UI/' + encodeURI(afterUi);
        out.push(mapped.endsWith('.png') || mapped.endsWith('.webp') ? mapped : (mapped + '.png'));
        out.push(mapped.endsWith('.png') || mapped.endsWith('.webp') ? mapped : (mapped + '.webp'));
      }

      return out;
    }

    function fallbackIconCandidatesByKey(traitKey) {
      const k = String(traitKey || '').toLowerCase();
      const leaf = encodeURIComponent(k);
      return [
        TRAIT_ICON_BASE + leaf + '.png',
        TRAIT_ICON_BASE + leaf + '.webp',
        `images/traits/${k}.png`,
        `images/traits/${k}.webp`
      ];
    }

    function setImgWithFallback(imgEl, candidates, onFailAll) {
      let i = 0;
      function tryNext() {
        if (i >= candidates.length) {
          if (typeof onFailAll === 'function') onFailAll();
          return;
        }
        imgEl.src = candidates[i++];
      }
      imgEl.onerror = tryNext;
      tryNext();
    }

    function buildTraitIcon(traitKey) {
      const trait = getTraitObject(traitKey) || { key: traitKey };

      const title = String(trait.title || traitKey || '').trim();
      const desc = String(trait.desc || trait.description || '').trim();

      const wrap = document.createElement('div');
      wrap.className = 'trait-icon';
      wrap.setAttribute('data-trait', traitKey);

      const tooltip = document.createElement('div');
      tooltip.className = 'trait-tooltip';
      tooltip.innerHTML = (() => {
        const eff = Array.isArray(trait.effects) ? trait.effects : [];
        const effHtml = eff.length
          ? `<div class="t-effects">
              <div class="t-effects-header">Effects</div>
              ${eff.map(e => `<div class="t-effect">${escapeHtml(String((e && e.name) || ''))}</div>`).join('')}
            </div>`
          : '';
        return `
          <p class="t-title">${escapeHtml(title || traitKey || 'Trait')}</p>
          <p class="t-desc">${escapeHtml(desc || '')}</p>
          ${effHtml}
        `;
      })();

      const img = document.createElement('img');
      img.alt = title || traitKey || 'Trait';

      const candidates = [];
      if (trait.icon_path) candidates.push(...normalizeIconCandidates(trait.icon_path));
      candidates.push(...fallbackIconCandidatesByKey(traitKey));

      setImgWithFallback(img, candidates, () => {
        img.remove();
        const badge = document.createElement('div');
        badge.className = 'trait-badge';
        const abbr = (title || traitKey || '??').replace(/[^a-z0-9]/ig, '').slice(0, 2).toUpperCase() || '??';
        badge.textContent = abbr;
        wrap.appendChild(badge);
      });

      wrap.appendChild(img);
      wrap.appendChild(tooltip);
      return wrap;
    }

    function renderTraitsIntoPortrait(traitKeys) {
      const portraitCol = document.getElementById('portrait-column');
      if (!portraitCol) return;

      let strip = document.getElementById('trait-strip');
      if (!strip) {
        strip = document.createElement('div');
        strip.id = 'trait-strip';
        strip.className = 'trait-strip';
        portraitCol.appendChild(strip);
      }

      strip.innerHTML = '';
      const keys = (Array.isArray(traitKeys) ? traitKeys : []).filter(Boolean);

      if (!keys.length) return;
      keys.forEach(k => strip.appendChild(buildTraitIcon(k)));
    }

    function extractNameForMissingCharacter(templateKey, currentFamilyName, relationship) {
        if (!templateKey) return 'Unknown';
        
        const isGeneric = templateKey.toLowerCase().includes('generic') || 
                         templateKey.toLowerCase().includes('villager') || 
                         templateKey.toLowerCase().includes('normal');
        
        if (isGeneric) {
            if (currentFamilyName) {
                if (relationship === 'parent' || relationship === 'sibling') {
                    return `${currentFamilyName} ???`;
                }
                else if (relationship === 'spouse') {
                    return 'Unknown Spouse';
                }
                else if (relationship === 'child') {
                    return `${currentFamilyName} ???`;
                }
            }
            return 'Unknown Relative';
        }
        
        const patterns = [
            /template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)_(?:hero_)?(?:fire|earth|water|wood|metal|nanman)$/,
            /template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)$/,
            /ironic_template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)_(?:hero_)?(?:fire|earth|water|wood|metal|nanman)$/,
            /ironic_template_(?:historical|generated|ancestral|fictional)_(?:lady_)?(.+?)$/,
        ];
        
        for (const pattern of patterns) {
            const match = templateKey.match(pattern);
            if (match) {
                const name = match[1].replace(/_/g, ' ');
                return name.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
            }
        }
        
        return templateKey.replace(/^.*template_/, '').replace(/_/g, ' ');
    }

    function renderFamilyMember(character, relationshipType, isMissing = false) {
        if (isMissing) {
            const relationLabel = relationshipType.charAt(0).toUpperCase() + relationshipType.slice(1);
            
            return `
                <div class="family-member family-member-missing"
                     title="${character.display_name} (No character data available)">
                    <span class="relationship-label">${relationLabel}</span>
                    <div class="family-portrait no-portrait">
                    </div>
                    <div class="family-member-name">
                        ${escapeHtml(character.display_name)}
                    </div>
                </div>
            `;
        }
        
        const details = (typeof CHARACTER_DETAILS_LOOKUP !== 'undefined')
            ? (CHARACTER_DETAILS_LOOKUP[character.key] || null)
            : null;
        
        const portraitUrl = details?.portrait?.url || '';
        const relationLabel = relationshipType.charAt(0).toUpperCase() + relationshipType.slice(1);

        return `
            <a href="character.html?key=${encodeURIComponent(character.key)}" 
               class="family-member"
               title="View ${character.display_name}'s page">
                <span class="relationship-label">${relationLabel}</span>
                <div class="family-portrait ${!portraitUrl ? 'no-portrait' : ''}"
                     ${portraitUrl ? `style="background-image: url('${escapeHtml(portraitUrl)}')"` : ''}>
                </div>
                <div class="family-member-name">
                    ${escapeHtml(character.display_name)}
                    ${character.display_name_alt ? `<br><span style="font-size: 0.65rem; opacity: 0.8;">${escapeHtml(character.display_name_alt)}</span>` : ''}
                </div>
            </a>
        `;
    }

    function renderFamilyTree(char) {
        if (typeof FAMILY_BY_CHARACTER === 'undefined' || typeof getFamilyMembers === 'undefined') {
            return '';
        }

        const familyMembers = getFamilyMembers(char.key);
        
        if (!familyMembers || familyMembers.length === 0) {
            return `
                <div class="family-tree-section">
                    <h3 class="family-tree-header">Family Tree</h3>
                    <div class="family-tree-empty">
                        No known family relationships for this character.
                    </div>
                </div>
            `;
        }

        const grouped = {
            parent: [],
            spouse: [],
            sibling: [],
            child: [],
            grandparent: [],
            grandchild: [],
            uncle: [],
            aunt: [],
            nephew: [],
            niece: [],
            cousin: []
        };

        familyMembers.forEach(rel => {
            const relatedChar = CHARACTER_DATA.find(c => c.key === rel.related_to);
            
            if (relatedChar) {
                grouped[rel.relationship] = grouped[rel.relationship] || [];
                grouped[rel.relationship].push({
                    character: relatedChar,
                    relationship: rel.relationship,
                    isMissing: false
                });
            } else {
                const placeholderChar = {
                    key: rel.related_to,
                    display_name: extractNameForMissingCharacter(rel.related_to, char.family_name, rel.relationship),
                    name_key: rel.related_name || ''
                };
                
                grouped[rel.relationship] = grouped[rel.relationship] || [];
                grouped[rel.relationship].push({
                    character: placeholderChar,
                    relationship: rel.relationship,
                    isMissing: true
                });
            }
        });

        let immediateHTML = '';
        const immediateOrder = [
            { key: 'parent', label: 'Parents' },
            { key: 'spouse', label: 'Spouses' },
            { key: 'sibling', label: 'Siblings' },
            { key: 'child', label: 'Children' }
        ];

        immediateOrder.forEach(relType => {
            const members = grouped[relType.key];
            if (members && members.length > 0) {
                immediateHTML += `
                    <div class="family-group">
                        <div class="family-group-title">${relType.label}</div>
                        <div class="family-members">
                            ${members.map(m => 
                                renderFamilyMember(m.character, relType.key, m.isMissing)
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        });

        let extendedHTML = '';
        const extendedTypes = [
            { key: 'grandparent', label: 'Grandparents' },
            { key: 'grandchild', label: 'Grandchildren' },
            { key: 'uncle', label: 'Uncles' },
            { key: 'aunt', label: 'Aunts' },
            { key: 'nephew', label: 'Nephews' },
            { key: 'niece', label: 'Nieces' },
            { key: 'cousin', label: 'Cousins' }
        ];

        let hasExtendedFamily = false;
        extendedTypes.forEach(relType => {
            const members = grouped[relType.key];
            if (members && members.length > 0) {
                hasExtendedFamily = true;
                extendedHTML += `
                    <div class="family-group">
                        <div class="family-group-title">${relType.label}</div>
                        <div class="family-members">
                            ${members.map(m => 
                                renderFamilyMember(m.character, relType.key, m.isMissing)
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        });

        let finalHTML = `
            <div class="family-tree-section">
                <h3 class="family-tree-header">Family Tree</h3>
                <div class="family-connections">
                    ${immediateHTML}
                </div>
        `;

        if (hasExtendedFamily) {
            finalHTML += `
                <div class="extended-family-section">
                    <h3 class="extended-family-header">Related To</h3>
                    <div class="family-connections">
                        ${extendedHTML}
                    </div>
                </div>
            `;
        }

        finalHTML += '</div>';

        return finalHTML;
    }

    function renderCharacter(char) {
      const details = (typeof CHARACTER_DETAILS_LOOKUP !== 'undefined')
        ? (CHARACTER_DETAILS_LOOKUP[char.key] || null)
        : null;

      const biography = (typeof CHARACTER_BIOS_LOOKUP !== 'undefined')
        ? (CHARACTER_BIOS_LOOKUP[char.key] || '')
        : '';

      document.title = `${char.display_name} | 190 Expanded Wiki`;

      const element = (char.element || 'unknown').toLowerCase();
      const portraitUrl = details?.portrait?.url || '';
      const effects = Array.isArray(details?.effects) ? details.effects : [];

      // Traits: prefer details.traits, fallback to char.traits
      const traits = Array.isArray(details?.traits) ? details.traits : (Array.isArray(char?.traits) ? char.traits : []);

      // Format birth/death years
      let dateStr = '';
      if (char.birth_year) {
        dateStr = `${char.birth_year} AD`;
        if (char?.death_year) {
          dateStr += ` – ${char.death_year} AD`;
        } else {
          dateStr += ' – ???';
        }
      }

      const root = document.getElementById('character-root');
      root.setAttribute('data-element', element);

      root.innerHTML = `
        <!-- Left Content Area -->
        <div class="content-area">
          <!-- Row 1: Title/Desc + Name/Info -->
          <div class="row-top">
            <!-- Title & Description -->
            <div class="panel panel-divider-right panel-divider-bottom title-panel">
              ${char.title
                ? `<h2 class="char-title" data-element="${escapeHtml(element)}">
                    ${escapeHtml(char.title)}
                  </h2>
                  `
                : ''
              }
              ${char.description
                ? `<p class="char-description">${escapeHtml(char.description)}</p>`
                : ''
              }
              ${!char.title && !char.description
                ? `<p class="no-title-desc">No title or description available.</p>`
                : ''
              }
            </div>

            <!-- Name & Info -->
            <div class="panel panel-divider-bottom info-panel">
              <h1>
                ${escapeHtml(char.display_name)}
                ${char.display_name_alt ? `<span class="chinese-name">${escapeHtml(char.display_name_alt)}</span>` : ''}
              </h1>
              ${char.courtesy_name ? `
                <p class="courtesy-name">
                  <span class="courtesy-label">Courtesy Name:</span> 
                  ${escapeHtml(char.courtesy_name)}
                  ${char.courtesy_name_alt ? `<span class="chinese-text">${escapeHtml(char.courtesy_name_alt)}</span>` : ''}
                </p>
              ` : ''}
              ${dateStr ? `<p class="char-dates">${escapeHtml(dateStr)}</p>` : ''}
              <div class="char-tags">
                <span class="tag ${char.is_unique ? 'unique' : 'generic'}">
                  ${char.is_unique ? 'Unique' : 'Generic'}
                </span>
                <span class="tag ${char.is_male ? 'male' : 'female'}">
                  ${char.is_male ? 'Male' : 'Female'}
                </span>
                <span class="tag element">
                  ${escapeHtml(element)}
                </span>
              </div>
            </div>
          </div>

          <!-- Row 2: Bio + Effects -->
          <div class="row-bottom">
            <!-- Biography -->
            <div class="panel panel-divider-right bio-panel">
              <h3 class="panel-header">Biography</h3>
              ${biography.trim()
                ? `<p class="bio-text">${escapeHtml(biography)}</p>`
                : `<p class="no-content">No biography available for this character.</p>`
              }

              <!-- Technical Details -->
              <details class="tech-details">
                <summary>Technical Details</summary>
                <dl>
                  <dt>Template Key</dt>
                  <dd><code>${escapeHtml(char.key)}</code></dd>
                  <dt>Name Key</dt>
                  <dd><code>${escapeHtml(char.name_key || '')}</code></dd>
                  <dt>Subtype</dt>
                  <dd>${escapeHtml(char.subtype || 'N/A')}</dd>
                  <dt>Forename</dt>
                  <dd>${escapeHtml(char.forename || 'N/A')} ${char.forename_alt ? `(${escapeHtml(char.forename_alt)})` : ''}</dd>
                  <dt>Family Name</dt>
                  <dd>${escapeHtml(char.family_name || 'N/A')} ${char.family_name_alt ? `(${escapeHtml(char.family_name_alt)})` : ''}</dd>
                  ${char.courtesy_name ? `
                    <dt>Courtesy</dt>
                    <dd>${escapeHtml(char.courtesy_name)} ${char.courtesy_name_alt ? `(${escapeHtml(char.courtesy_name_alt)})` : ''}</dd>
                  ` : ''}
                </dl>
              </details>
            </div>

            <!-- Effects -->
            <div class="panel effects-panel">
              <h3 class="panel-header">Effects</h3>
              <div id="effects-container"></div>
            </div>
          </div>
        </div>

        <!-- Right Portrait Column -->
        <div class="portrait-column" id="portrait-column" ${portraitUrl ? `style="background-image: url('${escapeHtml(portraitUrl)}')"` : ''}>
          ${portraitUrl ? '<button class="portrait-toggle" id="portrait-toggle" title="Toggle fit mode">Fit</button>' : ''}
          ${!portraitUrl ? '<div class="no-portrait-placeholder">No Portrait Available</div>' : ''}
          <div class="trait-strip" id="trait-strip"></div>
        </div>
      `;

      // Render categorized effects
      renderEffects(effects);

      // Render traits (icons next to portrait)
      renderTraitsIntoPortrait(traits);

      // Render family tree
      const familyTreeRoot = document.getElementById('family-tree-root');
      if (familyTreeRoot) {
        familyTreeRoot.innerHTML = renderFamilyTree(char);
      }

      // Portrait toggle functionality
      if (portraitUrl) {
        const portraitCol = document.getElementById('portrait-column');
        const toggleBtn = document.getElementById('portrait-toggle');

        const img = new Image();
        img.onload = function() {
          const imgRatio = img.width / img.height;
          if (imgRatio > 1.2 || imgRatio < 0.4) {
            portraitCol.classList.add('contain-mode');
            toggleBtn.textContent = 'Fill';
          }
        };
        img.src = portraitUrl;

        toggleBtn.addEventListener('click', function() {
          portraitCol.classList.toggle('contain-mode');
          toggleBtn.textContent = portraitCol.classList.contains('contain-mode') ? 'Fill' : 'Fit';
        });
      }
    }

    function categorizeEffects(effects) {
      const categories = {
        attributes: { label: 'Attributes', items: [], order: 1 },
        lives: { label: 'Lives', items: [], order: 2 },
        wealth: { label: 'Wealth', items: [], order: 3 },
        ai_hint: { label: 'AI Hint', items: [], order: 4 },
        other: { label: 'Other', items: [], order: 5 }
      };

      const attributeKeywords = ['instinct', 'resolve', 'cunning', 'expertise', 'authority'];

      effects.forEach(eff => {
        const name = (eff.name || '').toLowerCase();

        if (attributeKeywords.some(attr => name.includes(attr))) {
          categories.attributes.items.push(eff);
        } else if (name.includes('lives') || name.includes('num_lives') || name.includes('life')) {
          categories.lives.items.push(eff);
        } else if (name.includes('wealth')) {
          categories.wealth.items.push(eff);
        } else if (name.includes('ai_hint') || name.includes('ai hint')) {
          categories.ai_hint.items.push(eff);
        } else {
          categories.other.items.push(eff);
        }
      });

      return categories;
    }

    function renderEffects(effects) {
      const container = document.getElementById('effects-container');

      if (!effects || effects.length === 0) {
        container.innerHTML = '<p class="no-content">No effects data available.</p>';
        return;
      }

      const categories = categorizeEffects(effects);
      const sortedCategories = Object.values(categories)
        .filter(cat => cat.items.length > 0)
        .sort((a, b) => a.order - b.order);

      if (sortedCategories.length === 0) {
        container.innerHTML = '<p class="no-content">No effects data available.</p>';
        return;
      }

      let html = '';
      sortedCategories.forEach(category => {
        html += `
          <div class="effect-category">
            <h4 class="effect-category-header">${escapeHtml(category.label)}</h4>
            <div class="effect-category-items">
              ${category.items.map(eff => {
                const name = eff.name || 'Effect';
                return `<div class="effect-item">${escapeHtml(name)}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderNotFound(key) {
      document.title = "Character not found | 190 Expanded Wiki";
      document.getElementById('character-root').innerHTML = `
        <div class="content-area" style="grid-column: 1 / -1;">
          <div class="panel title-panel" style="min-height: 200px;">
            <h2 class="char-title">Character Not Found</h2>
            <p class="char-description">No character exists with the key: <code>${escapeHtml(key)}</code></p>
          </div>
        </div>
      `;
    }

    // Initialize
    const params = new URLSearchParams(window.location.search);
    const key = params.get('key');

    if (!key) {
      renderNotFound('(no key provided)');
    } else {
      const char = (typeof CHARACTER_DATA !== 'undefined')
        ? CHARACTER_DATA.find(c => c.key === key)
        : null;

      if (!char) {
        renderNotFound(key);
      } else {
        renderCharacter(char);
      }
    }
  </script>
</body>
</html>
