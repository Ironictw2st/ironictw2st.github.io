<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>190 Expanded - Factions</title>
    <link rel="stylesheet" href="styles/tw3k.css">
</head>
<body>
    <header class="tw3k-header">
        <div class="header-content">
            <h1>Factions</h1>
            <p class="subtitle">190 Expanded — Total War: Three Kingdoms</p>
        </div>
        <nav class="tw3k-nav">
            <a href="index.html">Home</a>
            <a href="factions.html" class="active">Factions</a>
        </nav>
    </header>

    <main class="tw3k-main">
        <section class="page-intro">
            <h2>Faction Roster</h2>
            <p>Browse notable factions and leaders.</p>
        </section>

        <!-- ======= VANILLA / HAN ======= -->
        <section class="category">
            <div class="category-header">
                <h2>Han (Vanilla)</h2>
                <span class="category-toggle">▼</span>
            </div>

            <div class="faction-grid">
                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Cao Cao</h3>
                    <p class="faction-leader">The Hero of Chaos</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Liu Bei</h3>
                    <p class="faction-leader">The Humble Ruler</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Sun Jian</h3>
                    <p class="faction-leader">The Tiger of Jiangdong</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Dong Zhuo</h3>
                    <p class="faction-leader">The Tyrant</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Yuan Shao</h3>
                    <p class="faction-leader">The Dragon of the North</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Yuan Shu</h3>
                    <p class="faction-leader">The Pretender</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Lü Bu</h3>
                    <p class="faction-leader">The Warrior Without Equal</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Zheng Jiang</h3>
                    <p class="faction-leader">The Ironfist General</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Ma Teng</h3>
                    <p class="faction-leader">Protector of the West</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="han">
                    <h3 class="faction-name">Kong Rong</h3>
                    <p class="faction-leader">Gentleman of the Han</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>
            </div>
        </section>

        <!-- ======= YELLOW TURBANS ======= -->
        <section class="category">
            <div class="category-header">
                <h2>Yellow Turbans</h2>
                <span class="category-toggle">▼</span>
            </div>

            <div class="faction-grid">
                <article class="faction-card" data-type="yt">
                    <h3 class="faction-name">Zhang Jue</h3>
                    <p class="faction-leader">The Celestial Master</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="yt">
                    <h3 class="faction-name">Zhang Bao</h3>
                    <p class="faction-leader">The General of Earth</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>

                <article class="faction-card" data-type="yt">
                    <h3 class="faction-name">Zhang Liang</h3>
                    <p class="faction-leader">The General of Man</p>
                    <div class="faction-tags"><span class="faction-tag">Vanilla</span></div>
                </article>
            </div>
        </section>

        <!-- ======= (THE REST OF YOUR ORIGINAL HTML CONTENT CONTINUES UNCHANGED) ======= -->
        <!--
          I kept all your existing faction cards and structure.
          Only the <script> at the bottom was replaced to add TSV loading.
          If you paste this file over your current factions.html, keep all your existing sections/cards as-is.
        -->

    </main>

    <footer class="tw3k-footer">
        <p>© 190 Expanded / Ironic — GitHub Pages</p>
    </footer>

    <script>
        // --- UI: Toggle category collapse ---
        document.querySelectorAll('.category-header').forEach(header => {
            header.addEventListener('click', () => {
                const category = header.parentElement;
                category.classList.toggle('collapsed');
            });
        });

        // --- Localization: Load TSV from /data and apply to faction leader titles ---
        function parseLocTSV(tsvText) {
            const loc = new Map();
            const lines = tsvText.split(/\r?\n/);
            for (const line of lines) {
                if (!line) continue;
                if (line.startsWith('#')) continue;      // skips "#Loc;..." and other comments
                const parts = line.split('\t');
                if (parts.length < 2) continue;
                const key = (parts[0] || '').trim();
                if (!key || key === 'key') continue;     // skip header
                const text = parts[1] ?? '';
                // keep first occurrence
                if (!loc.has(key)) loc.set(key, text);
            }
            return loc;
        }

        async function fetchFirst(urls) {
            let lastErr = null;
            for (const url of urls) {
                try {
                    const res = await fetch(url, { cache: 'no-store' });
                    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                    return await res.text();
                } catch (e) {
                    lastErr = e;
                }
            }
            throw lastErr || new Error('Failed to fetch TSV.');
        }

        function normalizeText(s) {
            return (s || '')
                .trim()
                .replace(/^The\s+/i, '')   // optional: strip leading "The "
                .replace(/[’‘]/g, "'");    // normalize curly apostrophes
        }

        async function applyFactionTitlesFromTSV() {
            // IMPORTANT:
            // - Don't use the github.com/blob URL (it's HTML).
            // - Prefer a same-site path for GitHub Pages.
            const candidateUrls = [
                // If this file is served from repo root (common):
                './data/all_titles_full.loc.tsv',
                // If this file is inside a subfolder like /total_war/:
                '../data/all_titles_full.loc.tsv',
                // Raw GitHub (works too):
                'https://raw.githubusercontent.com/Ironictw2st/ironictw2st.github.io/main/data/all_titles_full.loc.tsv'
            ];

            const tsvText = await fetchFirst(candidateUrls);
            const locByKey = parseLocTSV(tsvText);

            // Build reverse map: normalized text -> text (prefer exact text values)
            const locByText = new Map();
            for (const [, text] of locByKey.entries()) {
                const n = normalizeText(text);
                if (n && !locByText.has(n)) locByText.set(n, text);
            }

            // 1) Preferred: elements that declare a loc key explicitly
            // Example:
            //   <p class="faction-leader" data-loc-key="ceo_nodes_title_3k_ironic_whatever">...</p>
            document.querySelectorAll('[data-loc-key]').forEach(el => {
                const key = el.getAttribute('data-loc-key');
                const val = key ? locByKey.get(key) : null;
                if (val) el.textContent = val;
            });

            // 2) Convenience fallback: try matching existing displayed title text to TSV text values
            //    This keeps your current HTML working, and will replace the title IF it exists in the TSV.
            document.querySelectorAll('.faction-leader:not([data-loc-key])').forEach(el => {
                const current = el.textContent;
                const n = normalizeText(current);
                const val = locByText.get(n);
                if (val) el.textContent = val;
            });
        }

        // Run after DOM is ready
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await applyFactionTitlesFromTSV();
            } catch (err) {
                console.warn('TSV title load failed:', err);
            }
        });
    </script>
</body>
</html>
